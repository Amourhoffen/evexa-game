<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evexa Buddy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for theming */
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --secondary-color: #a78bfa; /* Violet 400 */
            --bg-dark: #1a202c; /* Dark charcoal - for body background */
            --bg-card: rgba(45, 55, 72, 0.3); /* Darker gray for cards - semi-transparent for glassmorphism */
            --text-light: #e2e8f0; /* Light gray */
            --text-muted: #a0aec0; /* Muted gray */
            --border-color: rgba(74, 85, 104, 0.4); /* Semi-transparent border */
            --box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 15px rgba(99, 102, 241, 0.15);
            --success-color: #10b981; /* Emerald */
            --warning-color: #f59e0b; /* Amber */
            --danger-color: #ef4444; /* Red */
            --sky-blue: #70c5ce; /* Default sky blue */
            --ground-brown: #d2b48c; /* Default ground brown */

            /* Sidebar specific variables (Dark Mode) - adjusted for glass effect */
            --sidebar-bg: rgba(30, 30, 30, 0.3); /* Dark background - semi-transparent */
            --sidebar-header-bg: rgba(42, 42, 42, 0.4);
            --sidebar-item-bg-hover: rgba(58, 58, 58, 0.5);
            --sidebar-item-text: #e0e0e0;
            --sidebar-item-icon: #a0a0a0;
            --sidebar-active-item-bg: rgba(51, 51, 51, 0.6);
            --sidebar-active-item-text: white;
            --sidebar-active-item-icon: white;
            --sidebar-border: rgba(51, 51, 51, 0.4);
            --sidebar-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);

            /* Bottom Navbar specific variables */
            --bottom-nav-bg: rgba(30, 30, 30, 0.4);
            --bottom-nav-item-color: #e0e0e0;
            --bottom-nav-active-bg: #007aff; /* iOS blue */
            --bottom-nav-active-color: white;
            --bottom-nav-border: rgba(51, 51, 51, 0.4);
            --bottom-nav-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);

            /* Game specific variables for canvas dimensions */
            --game-canvas-width: 550;
            --game-canvas-height: 450;
        }

        /* Light Mode Variables */
        body.light-mode {
            --primary-color: #4f46e5; /* Indigo 600 */
            --secondary-color: #8b5cf6; /* Violet 500 */
            --bg-dark: #f0f4f8; /* Light blue-gray - for body background */
            --bg-card: rgba(255, 255, 255, 0.6); /* White - semi-transparent for glassmorphism */
            --text-light: #2d3748; /* Dark gray */
            --text-muted: #718096; /* Medium gray */
            --border-color: rgba(203, 213, 224, 0.6); /* Light border - semi-transparent */
            --box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 0 15px rgba(79, 70, 229, 0.08);
            --success-color: #059669; /* Darker Emerald */
            --warning-color: #d97706; /* Darker Amber */
            --danger-color: #dc2626; /* Darker Red */
            --sky-blue: #87ceeb; /* Lighter sky blue */
            --ground-brown: #deb887; /* Slightly darker brown */

            /* Sidebar specific variables (Light Mode) - adjusted for glass effect */
            --sidebar-bg: rgba(255, 255, 255, 0.6); /* Light background - semi-transparent */
            --sidebar-header-bg: rgba(245, 245, 245, 0.7);
            --sidebar-item-bg-hover: rgba(224, 224, 224, 0.8);
            --sidebar-item-text: #333;
            --sidebar-item-icon: #666;
            --sidebar-active-item-bg: rgba(224, 224, 224, 0.9);
            --sidebar-active-item-text: #333;
            --sidebar-active-item-icon: #333;
            --sidebar-border: rgba(204, 204, 204, 0.6);
            --sidebar-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);

            /* Bottom Navbar specific variables */
            --bottom-nav-bg: rgba(255, 255, 255, 0.7);
            --bottom-nav-item-color: #333;
            --bottom-nav-active-bg: #007aff; /* iOS blue */
            --bottom-nav-active-color: white;
            --bottom-nav-border: rgba(204, 204, 204, 0.6);
            --bottom-nav-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1117 100%);
            color: var(--text-light);
            transition: background 0.5s ease, color 0.5s ease;
            overflow: hidden; /* Ensure no scrollbars on the body */
            padding: 0;
            box-sizing: border-box;
        }

        /* Glassmorphism effect base */
        .glass-effect {
            backdrop-filter: blur(12px); /* Increased blur */
            -webkit-backdrop-filter: blur(12px); /* For Safari support */
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
        }

        /* Custom Scrollbar Styling (for WebKit browsers like Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 8px; /* Thin scrollbar */
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1); /* Subtle track */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.5); /* Semi-transparent grey thumb */
            border-radius: 10px;
            border: 2px solid transparent; /* Creates a gap around the thumb */
            background-clip: padding-box; /* Ensures border doesn't affect thumb size */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.7); /* Slightly darker on hover */
        }

        /* Sidebar Styling */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 60px; /* Default collapsed width */
            background-color: var(--sidebar-bg); /* Use semi-transparent bg for glass */
            transition: width 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
            z-index: 50;
            overflow-y: auto; /* Enable scrolling for long menus */
            overflow-x: hidden; /* Hide horizontal scrollbar */
            padding: 20px 0; /* Apply padding here */
            box-sizing: border-box; /* Include padding in width calculation */
            /* Apply glass effect */
            backdrop-filter: blur(12px); /* Increased blur */
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid var(--sidebar-border); /* Use semi-transparent border */
            box-shadow: var(--sidebar-shadow);
            display: flex; /* Ensure flex properties are applied */
            flex-direction: column; /* Ensure flex properties are applied */
        }

        .sidebar.expanded {
            width: 250px; /* Expanded width */
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 5px;
        }

        .sidebar nav ul li a,
        .sidebar nav ul li button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 20px;
            color: var(--sidebar-item-text);
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 8px;
            overflow: hidden;
        }

        .sidebar nav ul li a i,
        .sidebar nav ul li button i {
            margin-right: 15px;
            color: var(--sidebar-item-icon);
            transition: color 0.2s ease, margin-right 0.3s ease;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar:not(.expanded) .sidebar nav ul li a span,
        .sidebar:not(.expanded) .sidebar nav ul li button span {
            opacity: 0;
            width: 0;
            white-space: nowrap;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar:not(.expanded) .sidebar nav ul li a i,
        .sidebar:not(.expanded) .sidebar nav ul li button i {
            margin-right: 0;
            justify-content: center;
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li button:hover {
            background-color: var(--sidebar-item-bg-hover);
        }

        .sidebar nav ul li.active > a,
        .sidebar nav ul li.active > button {
            background-color: var(--sidebar-active-item-bg);
            color: var(--sidebar-active-item-text);
        }

        .sidebar nav ul li.active > a i,
        .sidebar nav ul li.active > button i {
            color: var(--sidebar-active-item-icon);
        }

        /* Sub-menu styling */
        .sidebar nav ul ul {
            padding-left: 40px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 0 0 8px 8px;
        }

        body.light-mode .sidebar nav ul ul {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .sidebar nav ul li.expanded > ul {
            max-height: 500px;
        }

        .sidebar nav ul li .sub-menu-toggle {
            margin-left: auto;
            font-size: 0.8em;
            transition: transform 0.2s ease;
        }

        .sidebar nav ul li.expanded .sub-menu-toggle {
            transform: rotate(90deg);
        }

        /* Theme toggle button in sidebar */
        #theme-toggle {
            margin-top: auto;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            margin-left: 20px;
            margin-right: 20px;
            transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .sidebar:not(.expanded) #theme-toggle {
            opacity: 0;
            pointer-events: none;
            width: 0;
            padding: 0;
            margin-left: 0;
            margin-right: 0;
        }

        #theme-toggle:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #theme-toggle:active {
            transform: translateY(0);
        }

        /* Sidebar Toggle Button for Desktop */
        .sidebar-toggle-desktop {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.15s ease, box-shadow 0.3s ease;
            box-shadow: var(--box-shadow);
            z-index: 51;
            display: none;
        }

        .sidebar-toggle-desktop:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Main content area */
        .main-content {
            margin-left: 60px; /* Space for the collapsed sidebar */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            transition: margin-left 0.3s ease;
            width: calc(100% - 60px);
            overflow-y: auto; /* Allow main content to scroll if needed */
            min-height: calc(100vh - 60px); /* Base for desktop: 100vh - top menu button area */
        }

        .sidebar.expanded + .main-content {
            margin-left: 250px; /* Space for the expanded sidebar */
            width: calc(100% - 250px);
        }

        /* Page containers */
        .page-content {
            width: 100%;
            max-width: 800px; /* Max width for content pages */
            background-color: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            box-sizing: border-box;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
            flex-grow: 1; /* Make it fill available vertical space in main-content */
            justify-content: center; /* Center content vertically within this page */
        }

        .page-content.active {
            display: flex; /* Show active page */
        }

        #home-page h1 {
            font-size: 2.8em;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }

        #home-page h3 {
            font-size: 1.8em;
            color: var(--text-light);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #home-page p {
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        #home-page ul {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            max-width: 400px;
        }

        #home-page ul li {
            margin-bottom: 8px;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }

        #home-page ul li::before {
            content: "\2022"; /* Bullet point */
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        #home-page .button {
            margin-top: 20px;
        }

        #game-selection-page h2 {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }

        #game-selection-page .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }

        .game-container {
            position: relative;
            background-color: var(--bg-card); /* Semi-transparent for glass */
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            width: 100%;
            max-width: 550px;
            box-sizing: border-box;
            /* Remove margin-top/bottom here, let parent flexbox center */
            /* Apply glass effect */
            backdrop-filter: blur(12px); /* Increased blur */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, width 0.3s ease, height 0.3s ease; /* Add transition for rotation */
        }

        canvas {
            background-color: var(--sky-blue); /* Controlled by JS/CSS variables */
            border: 3px solid var(--border-color);
            border-radius: 15px;
            display: block;
            width: 100%;
            height: 450px; /* Default height for larger screens */
            touch-action: manipulation;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Ground styling */
        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: var(--ground-brown); /* Controlled by JS/CSS variables */
            border-top: 3px solid var(--border-color);
            border-radius: 0 0 15px 15px;
            z-index: 5;
        }

        #score-display {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3.2em;
            font-weight: 800;
            color: white;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.6);
            z-index: 10;
            transition: transform 0.1s ease-out, font-size 0.1s ease-out;
        }

        #score-display.score-pop {
            transform: translateX(-50%) scale(1.1);
            font-size: 3.5em;
        }

        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Still mostly opaque for readability */
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            text-align: center;
            gap: 15px;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
            transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.4s ease;
            /* Apply glass effect to game over screen too */
            backdrop-filter: blur(8px); /* Slightly less blur for readability */
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
        }

        #game-over-screen.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        #game-over-screen h2 {
            font-size: 2.8em;
            font-weight: 800;
            color: var(--danger-color);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
            margin-bottom: 5px;
            animation: bounceIn 0.8s ease-out;
        }

        #final-score {
            font-size: 2em;
            font-weight: 700;
            color: var(--warning-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        #high-score {
            font-size: 1.1em;
            color: var(--text-light);
            margin-top: 5px;
        }

        .button {
            padding: 14px 30px;
            font-size: 1.2em;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .button-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button-primary:hover {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 15px var(--primary-color);
        }

        .button-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Bottom Navbar Styling */
        .bottom-navbar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px; /* Height of the bottom navbar */
            display: none; /* Hidden by default */
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 100; /* Ensure it's on top */
            background-color: var(--bottom-nav-bg);
            border-top: 1px solid var(--bottom-nav-border);
            box-shadow: var(--bottom-nav-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 5px 0;
            color: var(--bottom-nav-item-color);
            font-size: 0.8em;
            text-decoration: none;
            transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease;
            border-radius: 10px;
            cursor: pointer;
            position: relative; /* For active indicator */
        }

        .bottom-nav-item i {
            font-size: 1.4em;
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .bottom-nav-item .icon-background {
            /* This div wraps the icon to allow for the active state background */
            width: 48px; /* Size of the active circle */
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .bottom-nav-item.active .icon-background {
            background-color: var(--bottom-nav-active-bg);
            color: var(--bottom-nav-active-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .bottom-nav-item.active i {
            color: var(--bottom-nav-active-color);
            z-index: 1; /* Ensure icon is above background */
        }

        .bottom-nav-item span {
            margin-top: 2px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .bottom-nav-item.active span {
            color: var(--bottom-nav-active-color);
        }

        /* Pre-game countdown styling */
        #countdown-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            font-weight: 800;
            color: white;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #countdown-display.active {
            opacity: 1;
            visibility: visible;
            animation: countdownPop 0.8s ease-out forwards;
        }

        @keyframes countdownPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Level Up message styling */
        #level-up-display {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #level-up-display.active {
            opacity: 1;
            visibility: visible;
            animation: levelUpFade 2s forwards;
        }

        @keyframes levelUpFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        /* Device rotation hint */
        #rotation-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            text-align: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #rotation-hint.active {
            opacity: 1;
            visibility: visible;
        }

        #rotation-hint i {
            font-size: 3em;
            margin-bottom: 20px;
            animation: rotateIcon 2s infinite ease-in-out;
        }

        #rotation-hint .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        #rotation-hint .button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        #rotation-hint .button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        #rotation-hint .button:active {
            transform: translateY(0);
        }

        @keyframes rotateIcon {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }

        /* Game Start Overlay */
        #game-start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
            z-index: 25; /* Above canvas, below countdown/game over */
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        #game-start-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #game-start-overlay p {
            margin: 0;
            padding: 10px;
        }

        /* Responsive adjustments */
        @media (min-width: 769px) {
            /* Show desktop toggle button */
            .sidebar-toggle-desktop {
                display: block;
            }
            /* Hide mobile toggle button */
            .menu-toggle-button {
                display: none;
            }
            /* Hide bottom navbar on desktop */
            .bottom-navbar-container {
                display: none;
            }
            /* Reset main-content padding for desktop */
            .main-content {
                padding-bottom: 20px; /* Original padding */
            }
            #rotation-hint {
                display: none; /* Hide on desktop */
            }
            .game-page .game-container {
                /* Center the game container on desktop */
                margin: auto; /* Auto margins for horizontal centering */
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0; /* Collapse sidebar by default on smaller screens */
                transform: translateX(-100%); /* Hide it off-screen */
                padding: 0;
            }

            .sidebar.active {
                width: 250px; /* Expand when active */
                transform: translateX(0%);
                padding: 20px 0;
            }

            .main-content {
                margin-left: 0; /* No margin when sidebar is collapsed */
                width: 100%; /* Take full width */
                padding-top: 80px; /* Space for fixed menu button at top */
                padding-bottom: 90px; /* Space for fixed bottom navbar */
                min-height: 100vh; /* Ensure it takes full viewport height */
                justify-content: center; /* Center content vertically in main-content */
            }

            .menu-toggle-button {
                display: block; /* Show hamburger menu button */
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 60; /* Above sidebar */
                background-color: var(--bg-card);
                color: var(--text-light);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 10px 15px;
                cursor: pointer;
                box-shadow: var(--box-shadow);
                transition: background-color 0.3s ease, color 0.3s ease;
            }

            .menu-toggle-button:hover {
                background-color: var(--primary-color);
                color: white;
            }

            /* Game container positioning on mobile */
            .game-page .game-container {
                /* Remove absolute positioning. Rely on flexbox centering from .page-content */
                position: static;
                top: auto;
                left: auto;
                transform: none; /* Reset any previous transforms */
                transform-origin: center center; /* Default */
                margin-top: 0; /* Reset margin from previous versions */
                margin-bottom: 0; /* Reset margin from previous versions */

                width: 90vw; /* User requested 90% width */
                height: auto; /* Let height be determined by aspect ratio */
                max-width: calc(100vw - (2 * 20px)); /* Ensure it doesn't exceed main-content width */
                max-height: calc(100vh - 170px); /* Adjusted for top button (60px) + bottom nav (80px) + main-content padding (2*20px) = 160px. Let's use 170px for safety */
                
                /* Ensure content within game-container is centered if it has flex properties */
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            /* Show bottom navbar on mobile */
            .bottom-navbar-container {
                display: flex;
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .game-page .game-container.rotated {
                transform: rotate(90deg);
                /* When rotated, visual width is its height, visual height is its width */
                height: auto; /* Let height be determined by aspect ratio */
                width: 90vw; /* Still aim for 90vw for the rotated 'width' */
                aspect-ratio: var(--game-canvas-height) / var(--game-canvas-width); /* Invert aspect ratio */
                max-height: calc(100vh - 170px); /* Still constrain by available vertical space */
            }

            .game-page .game-container.no-rotate {
                transform: rotate(0deg); /* Explicitly no rotation */
                width: 90vw; /* Maximize width in portrait */
                height: auto; /* Let height adjust dynamically */
                aspect-ratio: var(--game-canvas-width) / var(--game-canvas-height); /* Maintain original aspect ratio */
                max-height: calc(100vh - 170px); /* Limit total height considering top/bottom bars */
            }

            /* For very small screens, adjust padding to maximize game area */
            @media (max-width: 400px) {
                .main-content {
                    padding-left: 10px; /* Reduce padding for tiny screens */
                    padding-right: 10px;
                    padding-top: 70px; /* Adjust top padding */
                    padding-bottom: 80px; /* Adjust bottom padding */
                }
                .game-page .game-container {
                    width: 95vw; /* Slightly more width for tiny screens */
                    max-height: calc(100vh - 160px); /* Adjusted for new padding */
                }
                .game-page .game-container.rotated {
                    height: auto;
                    width: 95vw;
                    max-height: calc(100vh - 160px);
                }
                .game-page .game-container.no-rotate {
                    width: 95vw;
                    max-height: calc(100vh - 160px);
                }
            }
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
                width: 100%;
                border-radius: 10px; /* Smaller radius for smaller screens */
                gap: 15px;
            }
            canvas {
                height: 500px; /* Increased height for mobile portrait when not rotated */
                border-radius: 10px;
            }
            #score-display {
                font-size: 2.8em;
                top: 25px;
            }
            #score-display.score-pop {
                font-size: 3.1em;
            }
            #game-over-screen {
                font-size: 1.1em;
                gap: 15px;
            }
            #game-over-screen h2 {
                font-size: 2.5em;
            }
            #final-score {
                font-size: 1.8em;
            }
            #high-score {
                font-size: 1em;
            }
            .button {
                padding: 12px 25px;
                font-size: 1.1em;
                border-radius: 8px;
            }
            .bottom-navbar-container {
                height: 80px; /* Slightly taller for better touch targets */
            }
            .bottom-nav-item i {
                font-size: 1.6em;
            }
            .bottom-nav-item.active .icon-background {
                width: 55px;
                height: 55px;
            }
            .bottom-nav-item span {
                font-size: 0.8em;
            }
        }

        @media (max-width: 400px) {
            canvas {
                height: 420px; /* Further increased height for smaller mobile when not rotated */
            }
            #score-display {
                font-size: 2.2em;
            }
            #score-display.score-pop {
                font-size: 2.5em;
            }
            #game-over-screen h2 {
                font-size: 2em;
            }
            #final-score {
                font-size: 1.5em;
            }
            #high-score {
                font-size: 0.9em;
            }
            .button {
                padding: 10px 20px;
                font-size: 1em;
            }
            .bottom-navbar-container {
                height: 70px;
            }
            .bottom-nav-item i {
                font-size: 1.3em;
            }
            .bottom-nav-item.active .icon-background {
                width: 48px;
                height: 48px;
            }
            .bottom-nav-item span {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle-button" id="menuToggleButton"><i class="fas fa-bars"></i></button>

    <div class="sidebar glass-effect" id="sidebar">
        <button class="sidebar-toggle-desktop" id="sidebarToggleDesktop"><i class="fas fa-chevron-left"></i></button>
        <nav>
            <ul>
                <li class="active"><a href="#" data-page="home-page"><i class="fas fa-home"></i> <span>Home</span></a></li>
                <li><a href="#" data-page="game-selection-page"><i class="fas fa-gamepad"></i> <span>Play Game</span></a></li>
                <li><a href="#"><i class="fas fa-eye"></i> <span>View Site</span></a></li>
                <li><a href="#"><i class="fas fa-store"></i> <span>Marketplace</span></a></li>
                <li id="postsMenuItem">
                    <button class="menu-item-toggle"><i class="fas fa-newspaper"></i> <span>Posts</span> <i class="fas fa-chevron-right sub-menu-toggle"></i></button>
                    <ul>
                        <li><a href="#"><i class="fas fa-plus"></i> <span>Create Post</span></a></li>
                        <li><a href="#"><i class="fas fa-file-alt"></i> <span>Drafts</span> <span style="margin-left: auto;">10</span></a></li>
                        <li><a href="#"><i class="fas fa-clock"></i> <span>Scheduled</span> <span style="margin-left: auto;">2</span></a></li>
                        <li><a href="#"><i class="fas fa-check-circle"></i> <span>Published</span> <span style="margin-left: auto;">28</span></a></li>
                    </ul>
                </li>
                <li><a href="#"><i class="fas fa-file"></i> <span>Pages</span></a></li>
                <li><a href="#"><i class="fas fa-chart-line"></i> <span>Performance</span></a></li>
                <li><a href="#"><i class="fas fa-tags"></i> <span>Tags</span></a></li>
                <li><a href="#"><i class="fas fa-users"></i> <span>Members</span></a></li>
                <li><a href="#"><i class="fas fa-paint-brush"></i> <span>Design</span></a></li>
            </ul>
        </nav>
        <button id="theme-toggle">Toggle Dark/Light Mode</button>
    </div>

    <div class="main-content">
        <div id="home-page" class="page-content active">
            <h1>Welcome to Evexa Buddy!</h1>
            <h3>About This Game</h3>
            <p>Evexa Buddy is an engaging and challenging endless runner game where you control a cute bird navigating through a treacherous world of pipes. Your goal is to fly as far as possible, collecting points by passing between pipes, and avoiding collisions. The game dynamically adjusts its difficulty as you progress, offering a fresh challenge with every level up!</p>
            <p><strong>How to Play:</strong> Simply tap or click anywhere on the screen (or press the Spacebar on desktop) to make the bird flap its wings and ascend. Release to let gravity pull it down. Master the timing to weave through the gaps!</p>
            <p><strong>Features:</strong></p>
            <ul>
                <li>Auto-adjusting difficulty (Very Easy to Very Hard)</li>
                <li>Dynamic background changes with each level</li>
                <li>High score tracking</li>
                <li>Responsive design for all devices</li>
            </ul>
            <h3>Who Made It?</h3>
            <p>Evexa Buddy was created by your friendly AI assistant to provide a fun and interactive gaming experience right here in your browser. Enjoy!</p>
            <button id="play-game-button" class="button button-primary">Play Evexa Buddy!</button>
        </div>

        <div id="game-selection-page" class="page-content">
            <h2>Choose Your Game!</h2>
            <div class="button-group">
                <button id="select-flappy-bird" class="button button-primary">Flappy Bird Game</button>
                <button class="button button-primary" disabled>Other Game (Coming Soon)</button>
            </div>
        </div>

        <div id="game-page" class="page-content">
            <div class="game-container glass-effect">
                <canvas id="gameCanvas"></canvas>
                <div id="score-display">0</div>
                <div id="countdown-display"></div>
                <div id="level-up-display"></div>
                <div id="game-over-screen">
                    <h2>Game Over!</h2>
                    <p>Your Score: <span id="final-score">0</span></p>
                    <p>High Score: <span id="high-score">0</span></p>
                    <button id="restart-button" class="button button-primary">Restart Game</button>
                </div>
                <div id="game-start-overlay">
                    <p>Tap to Play</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-navbar-container glass-effect" id="bottomNavbar">
        <a href="#" class="bottom-nav-item active" id="homeNavItem" data-page="home-page">
            <div class="icon-background">
                <i class="fas fa-home"></i>
            </div>
            <span>Home</span>
        </a>
        <a href="#" class="bottom-nav-item" id="gameNavItem" data-page="game-selection-page">
            <div class="icon-background">
                <i class="fas fa-gamepad"></i>
            </div>
            <span>Game</span>
        </a>
        <a href="#" class="bottom-nav-item" id="appsNavItem">
            <div class="icon-background">
                <i class="fas fa-th-large"></i>
            </div>
            <span>Apps</span>
        </a>
        <a href="#" class="bottom-nav-item" id="profileNavItem">
            <div class="icon-background">
                <i class="fas fa-user"></i>
            </div>
            <span>Profile</span>
        </a>
    </div>

    <div id="rotation-hint">
        <i class="fas fa-mobile-alt"></i>
        <p>Rotate Device for Best Experience</p>
        <div class="button-group">
            <button id="play-portrait-button" class="button button-primary">Play Portrait</button>
            <button id="rotate-and-play-button" class="button button-primary">Rotate & Play</button>
        </div>
    </div>

    <script>
        // Global variables for game state and elements
        let canvas, ctx, scoreDisplay, gameOverScreen, finalScoreDisplay, highScoreDisplay, restartButton;
        let countdownDisplay, levelUpDisplay, rotationHint;
        let birdX, birdY, birdVelocityY;
        let pipes = [];
        let score;
        let highScore = 0;
        let gameOver;
        let lastPipeSpawnTime = 0;
        let animationFrameId;
        let gameStartTime;
        let currentPipeSpeed;
        let currentPipeSpawnInterval;
        let hasPlayedGameOverSound;
        let gameStarted = false; // Track if game has truly started (after countdown)
        let currentLevel = 1; // New: Current game level, starts at 1 (Very Easy)
        
        // New: User preference for rotation. Default to true (suggest rotation)
        let userPrefersRotation = JSON.parse(localStorage.getItem('userPrefersRotation')) !== false; 
        let rotationHintDismissed = false; // Track if user skipped rotation hint for the current session

        // Game states enum
        const GAME_STATES = {
            GAME_START_OVERLAY: 'GAME_START_OVERLAY', // New initial state for game page
            COUNTDOWN: 'COUNTDOWN',
            PLAYING: 'PLAYING',
            GAME_OVER: 'GAME_OVER'
        };
        let currentGameState; // Will be set by initGame or showPage

        // Page elements
        let homePage, gameSelectionPage, gamePage, gameStartOverlay;

        // Game constants
        const BIRD_WIDTH = 40;
        const BIRD_HEIGHT = 30;
        const INITIAL_GRAVITY = 0.5;
        const INITIAL_JUMP_STRENGTH = -8;
        const PIPE_WIDTH = 60;
        const PIPE_GAP = 150;
        const GROUND_HEIGHT = 80;

        // Desired internal canvas resolution for game logic (landscape)
        const GAME_CANVAS_WIDTH = 550;
        const GAME_CANVAS_HEIGHT = 450;

        // Difficulty levels (speed and spawn interval) with background themes
        const DIFFICULTY_LEVELS = {
            1: { speed: 2, interval: 1500, scoreThreshold: 5, name: "Very Easy", skyColor: '#70c5ce', groundColor: '#d2b48c', backgroundType: 'default' },
            2: { speed: 2.5, interval: 1300, scoreThreshold: 10, name: "Easy", skyColor: '#87CEEB', groundColor: '#deb887', backgroundType: 'clouds' },
            3: { speed: 3, interval: 1100, scoreThreshold: 20, name: "Medium", skyColor: '#4A90E2', groundColor: '#7a5230', backgroundType: 'mountains' },
            4: { speed: 3.5, interval: 900, scoreThreshold: 35, name: "Hard", skyColor: '#36454F', groundColor: '#5a3a2b', backgroundType: 'night' },
            5: { speed: 4, interval: 700, scoreThreshold: 50, name: "Very Hard", skyColor: '#2C3E50', groundColor: '#4a2a1c', backgroundType: 'stormy' }
        };

        // Bird colors (fixed, not changing per level as per user request)
        const BIRD_COLORS = {
            body: '#FFD700', /* Gold yellow */
            beak: '#FFA500', /* Orange */
            eye: 'black',
            wing: 'rgba(255, 255, 255, 0.7)'
        };

        // Sound effects and music using Tone.js
        let jumpSynth = null;
        let gameOverSynth = null;
        let backgroundMusicLoop = null; // Tone.Loop instance
        let backgroundMusicSynth = null; // Tone.Synth for background music

        // Function to set canvas dimensions dynamically
        function setCanvasDimensions() {
            // Always set canvas internal resolution to the desired landscape size
            canvas.width = GAME_CANVAS_WIDTH;
            canvas.height = GAME_CANVAS_HEIGHT;
            // CSS will handle visual scaling and rotation of the game-container and canvas
        }

        // Draw bird (stylized using Canvas API) - now uses fixed colors
        function drawBird() {
            // Bird body (oval)
            ctx.fillStyle = BIRD_COLORS.body;
            ctx.beginPath();
            ctx.ellipse(birdX + BIRD_WIDTH / 2, birdY + BIRD_HEIGHT / 2, BIRD_WIDTH / 2, BIRD_HEIGHT / 2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#DAA520'; /* Goldenrod */
            ctx.lineWidth = 2;
            ctx.stroke();

            // Beak (triangle)
            ctx.fillStyle = BIRD_COLORS.beak;
            ctx.beginPath();
            ctx.moveTo(birdX + BIRD_WIDTH - 5, birdY + BIRD_HEIGHT / 2);
            ctx.lineTo(birdX + BIRD_WIDTH + 10, birdY + BIRD_HEIGHT / 2 - 5);
            ctx.lineTo(birdX + BIRD_WIDTH + 10, birdY + BIRD_HEIGHT / 2 + 5);
            ctx.closePath();
            ctx.fill();

            // Eye (black circle with white highlight)
            ctx.fillStyle = BIRD_COLORS.eye;
            ctx.beginPath();
            ctx.arc(birdX + BIRD_WIDTH / 2 + 8, birdY + BIRD_HEIGHT / 2 - 5, 4, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(birdX + BIRD_WIDTH / 2 + 9, birdY + BIRD_HEIGHT / 2 - 6, 1.5, 0, Math.PI * 2);
            ctx.fill();

            // Simple wing (animated, slight rotation)
            ctx.save();
            ctx.translate(birdX + BIRD_WIDTH / 2, birdY + BIRD_HEIGHT / 2);
            let wingRotation = Math.sin(Date.now() * 0.01) * 0.2;
            ctx.rotate(wingRotation);

            ctx.fillStyle = BIRD_COLORS.wing;
            ctx.beginPath();
            ctx.ellipse(0, 5, BIRD_WIDTH / 3, BIRD_HEIGHT / 3, Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        // Draw pipes
        function drawPipes() {
            pipes.forEach(pipe => {
                // Top pipe
                ctx.fillStyle = '#228B22';
                ctx.strokeStyle = '#006400';
                ctx.lineWidth = 3;

                ctx.beginPath();
                ctx.rect(pipe.x, 0, PIPE_WIDTH, pipe.topHeight);
                ctx.fill();
                ctx.stroke();

                // Top pipe cap
                ctx.fillStyle = '#3CB371';
                ctx.beginPath();
                ctx.rect(pipe.x - 5, pipe.topHeight - 20, PIPE_WIDTH + 10, 20);
                ctx.fill();
                ctx.stroke();

                // Bottom pipe
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.rect(pipe.x, pipe.bottomY, PIPE_WIDTH, canvas.height - pipe.bottomY - GROUND_HEIGHT);
                ctx.fill();
                ctx.stroke();

                // Bottom pipe cap
                ctx.fillStyle = '#3CB371';
                ctx.beginPath();
                ctx.rect(pipe.x - 5, pipe.bottomY, PIPE_WIDTH + 10, 20);
                ctx.fill();
                ctx.stroke();
            });
        }

        // Draw dynamic background elements based on level
        function drawBackgroundElements(level) {
            const backgroundType = DIFFICULTY_LEVELS[level].backgroundType;

            if (backgroundType === 'clouds' || backgroundType === 'default') {
                // Draw simple clouds
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(canvas.width * 0.2, canvas.height * 0.2, 30, 0, Math.PI * 2);
                ctx.arc(canvas.width * 0.25, canvas.height * 0.2 + 10, 25, 0, Math.PI * 2);
                ctx.arc(canvas.width * 0.3, canvas.height * 0.2, 30, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(canvas.width * 0.7, canvas.height * 0.15, 40, 0, Math.PI * 2);
                ctx.arc(canvas.width * 0.75, canvas.height * 0.15 + 15, 35, 0, Math.PI * 2);
                ctx.arc(canvas.width * 0.8, canvas.height * 0.15, 40, 0, Math.PI * 2);
                ctx.fill();
            } else if (backgroundType === 'mountains' || backgroundType === 'night' || backgroundType === 'stormy') {
                // Draw simple mountains
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; /* Darker overlay for mountains */
                ctx.beginPath();
                ctx.moveTo(0, canvas.height - GROUND_HEIGHT);
                ctx.lineTo(canvas.width * 0.3, canvas.height - GROUND_HEIGHT - 80);
                ctx.lineTo(canvas.width * 0.6, canvas.height - GROUND_HEIGHT - 40);
                ctx.lineTo(canvas.width * 0.8, canvas.height - GROUND_HEIGHT - 100);
                ctx.lineTo(canvas.width, canvas.height - GROUND_HEIGHT);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; /* Lighter overlay for mountains */
                ctx.beginPath();
                ctx.moveTo(canvas.width * 0.1, canvas.height - GROUND_HEIGHT);
                ctx.lineTo(canvas.width * 0.4, canvas.height - GROUND_HEIGHT - 60);
                ctx.lineTo(canvas.width * 0.7, canvas.height - GROUND_HEIGHT - 20);
                ctx.lineTo(canvas.width, canvas.height - GROUND_HEIGHT);
                ctx.closePath();
                ctx.fill();
            }
        }

        // Draw ground
        function drawGround() {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ground-brown');
            ctx.fillRect(0, canvas.height - GROUND_HEIGHT, canvas.width, GROUND_HEIGHT);

            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 2;
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i, canvas.height - GROUND_HEIGHT);
                ctx.lineTo(i + 10, canvas.height - GROUND_HEIGHT + 10);
                ctx.stroke();
            }
        }

        // Update game state
        function update() {
            if (currentGameState !== GAME_STATES.PLAYING) return;

            birdVelocityY += INITIAL_GRAVITY;
            birdY += birdVelocityY;

            if (birdY + BIRD_HEIGHT > canvas.height - GROUND_HEIGHT) {
                birdY = canvas.height - BIRD_HEIGHT - GROUND_HEIGHT;
                currentGameState = GAME_STATES.GAME_OVER;
            }
            if (birdY < 0) {
                birdY = 0;
                birdVelocityY = 0;
            }

            // Check for level up
            const nextLevelData = DIFFICULTY_LEVELS[currentLevel + 1];
            if (nextLevelData && score >= DIFFICULTY_LEVELS[currentLevel].scoreThreshold) {
                currentLevel++;
                applyLevelDifficulty();
                showLevelUpMessage(currentLevel);
            }

            const currentTime = Date.now();
            if (currentTime - lastPipeSpawnTime > currentPipeSpawnInterval) {
                const minHeight = 50;
                const maxHeight = canvas.height - PIPE_GAP - minHeight - GROUND_HEIGHT;
                const topHeight = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
                const bottomY = topHeight + PIPE_GAP;
                pipes.push({ x: canvas.width, topHeight: topHeight, bottomY: bottomY, passed: false });
                lastPipeSpawnTime = currentTime;
            }

            pipes.forEach(pipe => {
                pipe.x -= currentPipeSpeed;

                if (
                    birdX < pipe.x + PIPE_WIDTH &&
                    birdX + BIRD_WIDTH > pipe.x &&
                    (birdY < pipe.topHeight || birdY + BIRD_HEIGHT > pipe.bottomY)
                ) {
                    currentGameState = GAME_STATES.GAME_OVER;
                }

                if (pipe.x + PIPE_WIDTH < birdX && !pipe.passed) {
                    score++;
                    scoreDisplay.textContent = score;
                    pipe.passed = true;

                    scoreDisplay.classList.add('score-pop');
                    setTimeout(() => {
                        scoreDisplay.classList.remove('score-pop');
                    }, 150);

                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('flappyBirdHighScore', highScore);
                        highScoreDisplay.textContent = highScore;
                    }
                }
            });

            pipes = pipes.filter(pipe => pipe.x + PIPE_WIDTH > 0);

            if (currentGameState === GAME_STATES.GAME_OVER) {
                finalScoreDisplay.textContent = score;
                gameOverScreen.classList.add('active');
                if (!hasPlayedGameOverSound && gameOverSynth) {
                    gameOverSynth.triggerAttackRelease("8n");
                    hasPlayedGameOverSound = true;
                }
                if (backgroundMusicLoop && backgroundMusicLoop.state === 'started') {
                    backgroundMusicLoop.stop();
                }
                cancelAnimationFrame(animationFrameId);
            }
        }

        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Update background colors based on current level
            document.documentElement.style.setProperty('--sky-blue', DIFFICULTY_LEVELS[currentLevel].skyColor);
            document.documentElement.style.setProperty('--ground-brown', DIFFICULTY_LEVELS[currentLevel].groundColor);

            drawBackgroundElements(currentLevel); // Draw level-specific background elements
            drawPipes();
            drawGround();
            drawBird();
            update();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Bird jump function
        function jump() {
            if (currentGameState === GAME_STATES.PLAYING) {
                birdVelocityY = INITIAL_JUMP_STRENGTH;
                if (jumpSynth) {
                    jumpSynth.triggerAttackRelease("C4", "8n");
                }
            } else if (currentGameState === GAME_STATES.GAME_START_OVERLAY) {
                // If on mobile portrait and user prefers rotation, show hint
                const isMobile = window.innerWidth < 769;
                const isPortrait = window.innerHeight > window.innerWidth;

                if (isMobile && isPortrait && userPrefersRotation && !rotationHintDismissed) {
                    rotationHint.classList.add('active');
                } else {
                    // Otherwise, proceed directly to countdown
                    gameStartOverlay.classList.add('hidden'); // Hide "Tap to Play"
                    startCountdown();
                }
            }
        }

        // Apply difficulty settings based on current level
        function applyLevelDifficulty() {
            const levelData = DIFFICULTY_LEVELS[currentLevel];
            if (levelData) {
                currentPipeSpeed = levelData.speed;
                currentPipeSpawnInterval = levelData.interval;
                console.log(`Level ${currentLevel}: Speed ${currentPipeSpeed}, Interval ${currentPipeSpawnInterval}`);
            } else {
                // If no specific level data, use the last defined level's settings
                const lastLevel = Object.keys(DIFFICULTY_LEVELS).pop();
                const lastLevelData = DIFFICULTY_LEVELS[lastLevel];
                currentPipeSpeed = lastLevelData.speed;
                currentPipeSpawnInterval = lastLevelData.interval;
                console.log(`Max Level Reached (${lastLevel}): Speed ${currentPipeSpeed}, Interval ${currentPipeSpawnInterval}`);
            }
        }

        // Show level up message
        function showLevelUpMessage(level) {
            levelUpDisplay.textContent = `Level ${level}!`;
            levelUpDisplay.classList.add('active');
            setTimeout(() => {
                levelUpDisplay.classList.remove('active');
            }, 2000); // Display for 2 seconds
        }

        // Countdown before game starts
        function startCountdown() {
            currentGameState = GAME_STATES.COUNTDOWN;
            let count = 3;
            countdownDisplay.classList.add('active');
            const countdownInterval = setInterval(() => {
                if (count > 0) {
                    countdownDisplay.textContent = count;
                    count--;
                } else {
                    countdownDisplay.textContent = 'Go!';
                    clearInterval(countdownInterval);
                    setTimeout(() => {
                        countdownDisplay.classList.remove('active');
                        currentGameState = GAME_STATES.PLAYING; // Allow game to start after countdown
                        gameStartTime = Date.now(); // Start game timer
                        gameLoop(); // Start the game loop
                        if (backgroundMusicLoop && backgroundMusicLoop.state !== 'started') {
                            backgroundMusicLoop.start();
                        }
                    }, 500); // "Go!" stays for 0.5s
                }
            }, 1000); // Update every 1 second
        }

        // Initialize game (starts directly now)
        function initGame() {
            setCanvasDimensions();
            birdX = 50;
            birdY = canvas.height / 2 - BIRD_HEIGHT / 2;
            birdVelocityY = 0;
            pipes = [];
            score = 0;
            gameOver = false;
            hasPlayedGameOverSound = false;
            lastPipeSpawnTime = 0;
            currentLevel = 1; // Always start at level 1 (Very Easy)
            applyLevelDifficulty(); // Apply initial difficulty

            // Ensure game elements are visible and overlay is shown
            canvas.style.display = 'block';
            scoreDisplay.style.display = 'block';
            gameOverScreen.classList.remove('active'); // Hide game over screen
            gameStartOverlay.classList.remove('hidden'); // Show "Tap to Play" overlay
            
            currentGameState = GAME_STATES.GAME_START_OVERLAY; // Set initial state for game page

            scoreDisplay.textContent = score;
            highScore = parseInt(localStorage.getItem('flappyBirdHighScore') || '0');
            highScoreDisplay.textContent = highScore;

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            // Do not start countdown here, it will be triggered by user interaction on overlay
        }

        // Start Tone.js audio context on user interaction
        const startAudioContext = () => {
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    console.log("Tone.js audio context started.");
                    // Initialize synths and connect them
                    jumpSynth = new Tone.Synth().toDestination();
                    gameOverSynth = new Tone.NoiseSynth().toDestination();
                    
                    // Initialize a single synth for background music and connect it
                    backgroundMusicSynth = new Tone.Synth().toDestination();

                    // Background music loop setup - it schedules notes on backgroundMusicSynth
                    backgroundMusicLoop = new Tone.Loop(time => {
                        backgroundMusicSynth.triggerAttackRelease("C3", "4n", time);
                        backgroundMusicSynth.triggerAttackRelease("E3", "4n", time + 0.5);
                        backgroundMusicSynth.triggerAttackRelease("G3", "4n", time + 1);
                        backgroundMusicSynth.triggerAttackRelease("C4", "4n", time + 1.5);
                    }, "2n"); // Repeat every 2 notes
                    
                    // The loop itself will be started after the countdown
                }).catch(e => console.error("Tone.js context failed to start:", e));
            }
        };

        // Function to show/hide pages
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            // Update active state in sidebar and bottom navbar
            const navLinks = document.querySelectorAll('.sidebar nav ul li a, .bottom-navbar-container .bottom-nav-item');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                }
            });

            // If navigating to game page, initialize the game
            if (pageId === 'game-page') {
                initGame();
            } else {
                // If navigating away from game, stop game loop and music
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                if (backgroundMusicLoop && backgroundMusicLoop.state === 'started') {
                    backgroundMusicLoop.stop();
                }
                // Ensure rotation hint is hidden when not on game page
                rotationHint.classList.remove('active');
            }
            checkOrientation(); // Re-evaluate orientation on page change
        }

        // Check device orientation and apply game box rotation
        function checkOrientation() {
            const isMobile = window.innerWidth < 769;
            const isPortrait = window.innerHeight > window.innerWidth;
            const gameContainer = document.querySelector('.game-container');
            const isOnGamePage = gamePage.classList.contains('active');

            if (isMobile && isOnGamePage) {
                if (isPortrait) {
                    // Mobile Portrait Mode
                    // Rotation hint is managed by jump()
                    
                    if (userPrefersRotation) {
                        // Apply CSS rotation to game-container
                        gameContainer.classList.remove('no-rotate');
                        gameContainer.classList.add('rotated');
                    } else {
                        // User prefers no rotation
                        gameContainer.classList.remove('rotated');
                        gameContainer.classList.add('no-rotate');
                    }

                } else {
                    // Mobile Landscape Mode
                    rotationHint.classList.remove('active');
                    // Reset game-container classes
                    gameContainer.classList.remove('rotated');
                    gameContainer.classList.remove('no-rotate');
                }
            } else {
                // Desktop Mode (or not on game page for mobile)
                rotationHint.classList.remove('active');
                // Ensure game-container classes are reset for desktop
                gameContainer.classList.remove('rotated');
                gameContainer.classList.remove('no-rotate');
            }
            setCanvasDimensions(); // Re-set canvas internal dimensions
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements to global variables
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            scoreDisplay = document.getElementById('score-display');
            gameOverScreen = document.getElementById('game-over-screen');
            finalScoreDisplay = document.getElementById('final-score');
            highScoreDisplay = document.getElementById('high-score');
            restartButton = document.getElementById('restart-button');
            countdownDisplay = document.getElementById('countdown-display');
            levelUpDisplay = document.getElementById('level-up-display');
            rotationHint = document.getElementById('rotation-hint');
            homePage = document.getElementById('home-page');
            gameSelectionPage = document.getElementById('game-selection-page'); // New
            gamePage = document.getElementById('game-page');
            gameStartOverlay = document.getElementById('game-start-overlay'); // New

            const playPortraitButton = document.getElementById('play-portrait-button'); // New
            const rotateAndPlayButton = document.getElementById('rotate-and-play-button'); // New
            const selectFlappyBirdButton = document.getElementById('select-flappy-bird'); // New

            // Sidebar elements
            const sidebar = document.getElementById('sidebar');
            const menuToggleButton = document.getElementById('menuToggleButton');
            const sidebarToggleDesktop = document.getElementById('sidebarToggleDesktop');
            const postsMenuItem = document.getElementById('postsMenuItem');
            const themeToggleButton = document.getElementById('theme-toggle');

            // Bottom Navbar elements
            const bottomNavbar = document.getElementById('bottomNavbar');
            const navLinks = document.querySelectorAll('.sidebar nav ul li a, .bottom-navbar-container .bottom-nav-item');
            const playGameButton = document.getElementById('play-game-button');


            // Attach event listeners to start audio context on first interaction
            document.addEventListener('click', startAudioContext, { once: true });
            document.addEventListener('keydown', startAudioContext, { once: true });
            document.addEventListener('touchstart', startAudioContext, { once: true });

            // Event Listeners for game
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    // Only jump if game is playing or on start overlay
                    if (currentGameState === GAME_STATES.PLAYING || currentGameState === GAME_STATES.GAME_START_OVERLAY) {
                        jump();
                    }
                }
            });

            // Unified click/tap handler for game jump (now also triggers game start overlay logic)
            gameStartOverlay.addEventListener('click', jump);
            gameStartOverlay.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling on touch
                jump();
            });
            // Add click/touchstart to canvas itself for when overlay is hidden
            canvas.addEventListener('click', jump);
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                jump();
            });


            // Restart button now directly re-initializes the game (which starts countdown)
            restartButton.addEventListener('click', initGame);

            // Play Game button on Home page
            if (playGameButton) {
                playGameButton.addEventListener('click', () => showPage('game-selection-page'));
            }

            // Game Selection buttons
            if (selectFlappyBirdButton) {
                selectFlappyBirdButton.addEventListener('click', () => showPage('game-page'));
            }

            // Rotation hint buttons
            if (playPortraitButton) {
                playPortraitButton.addEventListener('click', () => {
                    rotationHintDismissed = true;
                    userPrefersRotation = false; // User explicitly opted out of rotation
                    localStorage.setItem('userPrefersRotation', false); // Save preference
                    rotationHint.classList.remove('active');
                    checkOrientation(); // Re-check orientation to apply non-rotated view
                    gameStartOverlay.classList.add('hidden'); // Hide "Tap to Play"
                    startCountdown(); // Start the game
                });
            }
            if (rotateAndPlayButton) {
                rotateAndPlayButton.addEventListener('click', () => {
                    rotationHintDismissed = true;
                    userPrefersRotation = true; // User explicitly opted in for rotation
                    localStorage.setItem('userPrefersRotation', true); // Save preference
                    rotationHint.classList.remove('active');
                    checkOrientation(); // Re-check orientation to apply rotated view
                    gameStartOverlay.classList.add('hidden'); // Hide "Tap to Play"
                    startCountdown(); // Start the game
                });
            }


            // Navigation links
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.page;
                    if (pageId) {
                        showPage(pageId);
                    }
                    // For mobile, close sidebar after navigation
                    if (window.innerWidth < 769) {
                        sidebar.classList.remove('active');
                    }
                });
            });

            // Sidebar Menu Toggle for small screens (hamburger icon)
            if (menuToggleButton) {
                menuToggleButton.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }

            // Sidebar Toggle for Desktop (chevron icon)
            if (sidebarToggleDesktop) {
                sidebarToggleDesktop.addEventListener('click', () => {
                    sidebar.classList.toggle('expanded');
                    // Update icon based on state
                    if (sidebar.classList.contains('expanded')) {
                        sidebarToggleDesktop.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    } else {
                        sidebarToggleDesktop.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                });
            }

            // Posts Sub-menu Toggle
            if (postsMenuItem) {
                const postsToggleButton = postsMenuItem.querySelector('.menu-item-toggle');
                if (postsToggleButton) {
                    postsToggleButton.addEventListener('click', () => {
                        postsMenuItem.classList.toggle('expanded');
                    });
                }
            }

            // Theme toggle functionality
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    if (document.body.classList.contains('light-mode')) {
                        localStorage.setItem('theme', 'light');
                        themeToggleButton.textContent = 'Toggle Dark Mode'; // Update button text
                    } else {
                        localStorage.setItem('theme', 'dark');
                        themeToggleButton.textContent = 'Toggle Light Mode'; // Update button text
                    }
                });
            }

            // Apply saved theme preference on load
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (themeToggleButton) themeToggleButton.textContent = 'Toggle Dark Mode';
            } else {
                document.body.classList.remove('light-mode');
                if (themeToggleButton) themeToggleButton.textContent = 'Toggle Light Mode';
            }

            // Initial setup: show home page
            showPage('home-page');

            // Handle window resize and orientation change
            window.addEventListener('resize', () => {
                checkOrientation(); // Check orientation on resize
            });
            window.addEventListener('orientationchange', checkOrientation); // For explicit orientation changes

            // Initial check on load, after all elements are ready
            checkOrientation(); 
        });
    </script>
</body>
</html>
